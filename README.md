# Описание

Экспортирует данные для мониторинга установленной копии КриптоПРО, в формате метрик Prometheus 

# Статус проекта

Пре-альфа версия

## Поддержка версий КриптоПРO:

- [x] 4.0
- [ ] прочие - не проверено

## Функциональность

- [x] Проверка статуса лицензии:
  - [x] активна/истекла
  - [x] постоянная или временная
  - [x] количество дней до истечения лицензии
- [x] Проверка пользовательских сертификатов
  - [x] список контейнеров  
  - [x] количество дней до истечения сертификатов в контейнерах 
- [x] Проверка номера версии
- [ ] Проверка корневых сертификатов
- [ ] Проверка промежуточных сертификатов

# Использование

## Сборка

Восстановление зависимостей
```
go mod vendor
```

Сборка
```
CGO_ENABLED=0 go build -v -ldflags="-s -w" -o cryptopro-exporter
```

Для сборки под другие ОС/архитектуры, отличные от среды сборки - добавьте к команде сборки переменные среды GOOS и GOARCH с нужными значениями 

## Запуск в режиме проверки конфигурации

Нужен для того чтобы убедиться, что экспортер корректно работает в запускаемой среде с указанными флагами и вашей версией криптопро

```bash
./cryptopro-exporter -ensure -certmgr /custom/path/to/certmgr
```

В выводе отобразится информация об успешности получения данных о криптопро и значения для метрик 

## Запуск в режиме экспортера

TLDR
```bash
./cryptopro-exporter
```
Эта команда запустит экспортер на 0.0.0.0:9189 .Будут использованы параметры запуска по умолчанию. См раздел Флаги

## Флаги

Флаг | Тип | Значение по умолчанию | Описание
---|---|---|---
addr | string | 0.0.0.0:9189 | Хост:порт на котором будет слушать экспортер 
cpconfig | string | /opt/cprocsp/sbin/amd64/cpconfig | Путь до исполняемого файла  
certmgr | string | /opt/cprocsp/bin/amd64/certmgr | Путь до исполняемого файла
cryptcp | string |  /opt/cprocsp/bin/amd64/cryptcp | Путь до исполняемого файла
period | int | 720 | Периодичность запуска проверок. В минутах
ensure | bool | - | запуск в тестовом режиме для проверки конфигурации и корректности возвращаемых значений

## Метрики

Название метрики | Тип | Описание
---|---|---
`cryptopro_version` | gauge | Номер версии. Версии вида 4.0 будут отображены как 4
`cryptopro_license_active` | gauge | Флаг активности лицензии. 1 - активна, 0 - не активна
`cryptopro_license_permanent` | gauge |  Флаг перманентной лицензии. 1 - перманентная, 0 - временная
`cryptopro_license_expires_in` | gauge | Количество дней до истечения лицензии
`cryptopro_user_certificate_expires_in` | gauge | Количество дней до истечения пользовательского сертификата. Название контейнера указывается в лейбле  `container
`cryptopro_exporter_errors_license` | counter | Количество ошибок, возникших при проверке лицензии
`cryptopro_exporter_errors_user_certificates` | counter | Количество ошибок, возникших при проверке пользовательских сертификатов
`cryptopro_exporter_errors_version` | counter | Количество ошибок, возникших при проверке версии КриптоПРО
`cryptopro_exporter_errors_total` | counter | Общее количество ошибок, возникших в процессе работы экспортера
